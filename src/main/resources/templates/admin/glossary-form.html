<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${term.id != null ? 'Edit Term' : 'Add New Term'} + ' - Admin Panel'">Add New Term - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
    <style>
        .admin-sidebar{min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}
        .admin-sidebar .nav-link{color:rgba(255,255,255,.8);padding:12px 20px;border-radius:8px;margin:4px 0;transition:.3s}
        .admin-sidebar .nav-link:hover,.admin-sidebar .nav-link.active{color:#fff;background:rgba(255,255,255,.1);transform:translateX(5px)}
        .admin-header{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:1rem 0}
        .admin-content{padding:2rem;background:#f8f9fa;min-height:calc(100vh - 80px)}
        .form-admin{background:#fff;border-radius:15px;padding:2rem;box-shadow:0 5px 15px rgba(0,0,0,.08)}
        .btn-admin{border-radius:8px;padding:10px 20px;font-weight:500;transition:.3s}
        .form-control,.form-select{border-radius:8px;border:2px solid #e9ecef;transition:.3s}
        .form-control:focus,.form-select:focus{border-color:#007bff;box-shadow:0 0 0 .2rem rgba(0,123,255,.25)}
        .media-preview{max-width:200px;max-height:200px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 admin-sidebar">
            <div class="p-3">
                <h4 class="text-white mb-4">
                    <i class="fas fa-shield-alt me-2"></i> CyberEdu Admin
                </h4>
                <nav class="nav flex-column">
                    <a class="nav-link" th:href="@{/admin}"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a>
                    <a class="nav-link active" th:href="@{/admin/glossary}"><i class="fas fa-book me-2"></i>Glossary Terms</a>
                    <a class="nav-link" th:href="@{/admin/learning}"><i class="fas fa-graduation-cap me-2"></i>Learning Modules</a>
                    <a class="nav-link" th:href="@{/admin/news}"><i class="fas fa-newspaper me-2"></i>News Articles</a>
                    <a class="nav-link" th:href="@{/admin/cheatsheets}"><i class="fas fa-file-alt me-2"></i>Cheat Sheets</a>
                    <a class="nav-link" th:href="@{/admin/inquiries}"><i class="fas fa-envelope me-2"></i>Inquiries</a>
                    <hr class="text-white-50">
                    <a class="nav-link" th:href="@{/}"><i class="fas fa-external-link-alt me-2"></i>View Website</a>
                </nav>
            </div>
        </div>

        <!-- Main -->
        <div class="col-md-9 col-lg-10">
            <div class="admin-header">
                <div class="container-fluid">
                    <div class="row align-items-center">
                        <div class="col">
                            <h2 class="mb-0" th:text="${term.id != null ? 'Edit Term' : 'Add New Term'}">Add New Term</h2>
                        </div>
                        <div class="col-auto">
                            <a th:href="@{/admin/glossary}" class="btn btn-outline-secondary btn-admin">
                                <i class="fas fa-arrow-left me-2"></i> Back to Glossary
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="admin-content">
                <!-- Flash -->
                <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span th:text="${success}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Form -->
                <div class="form-admin">
                    <!-- ✅ FIXED: action endpoint -->
                    <form th:action="@{/admin/glossary}" th:object="${term}" method="post" enctype="multipart/form-data">
                        <!-- ✅ Include hidden id so edits work -->
                        <input type="hidden" th:field="*{id}"/>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="term" class="form-label">
                                        <i class="fas fa-tag me-2"></i> Term *
                                    </label>
                                    <input type="text" class="form-control" id="term" th:field="*{term}"
                                           placeholder="e.g., Phishing, Malware, Firewall" required>
                                </div>

                                <div class="mb-3">
                                    <label for="definition" class="form-label">
                                        <i class="fas fa-align-left me-2"></i> Definition *
                                    </label>
                                    <textarea class="form-control" id="definition" th:field="*{definition}" rows="4"
                                              placeholder="Provide a clear and comprehensive definition..." required></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="example" class="form-label">
                                        <i class="fas fa-lightbulb me-2"></i> Example
                                    </label>
                                    <textarea class="form-control" id="example" th:field="*{example}" rows="3"
                                              placeholder="Provide a real-world example or use case..."></textarea>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="category" class="form-label">
                                                <i class="fas fa-folder me-2"></i> Category
                                            </label>
                                            <select class="form-select" id="category" th:field="*{category}">
                                                <option value="">Select Category</option>
                                                <option value="Network Security">Network Security</option>
                                                <option value="Malware">Malware</option>
                                                <option value="Social Engineering">Social Engineering</option>
                                                <option value="Cryptography">Cryptography</option>
                                                <option value="Incident Response">Incident Response</option>
                                                <option value="Compliance">Compliance</option>
                                                <option value="Risk Management">Risk Management</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="isPublished" class="form-label">
                                                <i class="fas fa-eye me-2"></i> Status
                                            </label>
                                            <select class="form-select" id="isPublished" th:field="*{isPublished}">
                                                <option value="true">Published</option>
                                                <option value="false">Draft</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="mediaFile" class="form-label">
                                        <i class="fas fa-image me-2"></i> Media File
                                    </label>
                                    <input type="file" class="form-control" id="mediaFile" name="mediaFile"
                                           accept="image/*,video/*,.pdf" onchange="previewMedia(this)">
                                    <div class="form-text">Upload an image, video, or PDF to illustrate this term</div>

                                    <!-- Media Preview -->
                                    <div id="mediaPreview" class="mt-3" style="display:none;">
                                        <img id="previewImage" class="media-preview" style="display:none;">
                                        <div id="previewVideo" style="display:none;">
                                            <video class="media-preview" controls>
                                                <source id="videoSource" src="">
                                            </video>
                                        </div>
                                        <div id="previewPdf" style="display:none;">
                                            <div class="alert alert-info">
                                                <i class="fas fa-file-pdf me-2"></i> PDF file selected
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Current Media -->
                                    <div th:if="${term.mediaUrl != null}" class="mt-3">
                                        <label class="form-label">Current Media:</label>
                                        <div th:if="${term.mediaType != null and term.mediaType.startsWith('image/')}">
                                            <img th:src="${term.mediaUrl}" class="media-preview">
                                        </div>
                                        <div th:if="${term.mediaType != null and term.mediaType.startsWith('video/')}">
                                            <video th:src="${term.mediaUrl}" class="media-preview" controls></video>
                                        </div>
                                        <div th:if="${term.mediaType != null and term.mediaType == 'application/pdf'}">
                                            <div class="alert alert-info">
                                                <i class="fas fa-file-pdf me-2"></i>
                                                <a th:href="${term.mediaUrl}" target="_blank">View PDF</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between">
                            <a th:href="@{/admin/glossary}" class="btn btn-outline-secondary btn-admin">
                                <i class="fas fa-times me-2"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary btn-admin">
                                <i class="fas fa-save me-2"></i>
                                <span th:text="${term.id != null ? 'Update Term' : 'Save Term'}">Save Term</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function previewMedia(input){
        const preview=document.getElementById('mediaPreview');
        const img=document.getElementById('previewImage');
        const vidWrap=document.getElementById('previewVideo');
        const pdf=document.getElementById('previewPdf');
        const vsrc=document.getElementById('videoSource');

        if(input.files && input.files[0]){
            const f=input.files[0]; const t=f.type;
            img.style.display='none'; vidWrap.style.display='none'; pdf.style.display='none';

            if(t.startsWith('image/')){
                const r=new FileReader(); r.onload=e=>{ img.src=e.target.result; img.style.display='block'; preview.style.display='block'; }; r.readAsDataURL(f);
            }else if(t.startsWith('video/')){
                const r=new FileReader(); r.onload=e=>{ vsrc.src=e.target.result; vsrc.type=t; vidWrap.style.display='block'; preview.style.display='block'; }; r.readAsDataURL(f);
            }else if(t==='application/pdf'){
                pdf.style.display='block'; preview.style.display='block';
            }
        }else{ preview.style.display='none'; }
    }
</script>
</body>
</html>